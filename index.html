<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„ç¤¾äº¤ä¾¦æ¢æ—¥è®° (ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        body {
            font-family: "ZCOOL KuaiLe", "YouYuan", "å¹¼åœ†", sans-serif; /* ä½¿ç”¨æ›´å¡é€šçš„å­—ä½“ */
            background-color: #f0f4f8;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            touch-action: none; /* å…¨å±€ç¦æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }

        /* å…è®¸è¾“å…¥æ¡†é€‰ä¸­ */
        input, textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
            touch-action: auto !important; /* æ¢å¤è¾“å…¥æ¡†çš„è§¦æ‘¸æ“ä½œ */
        }

        #canvas-container {
            background-color: #F9F7F2;
            background-image: 
                radial-gradient(#CBD5E0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }
        #canvas-container.mode-link { cursor: crosshair; }

        .sidebar-item {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            touch-action: none;
            position: relative;
        }
        .sidebar-item:active { transform: scale(0.9); }
        .sidebar-item:hover { transform: scale(1.05); }

        /* å¢åŠ ç‚¹å‡»åé¦ˆ */
        .btn-press:active { transform: scale(0.95); }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }

        .diary-card {
            border-left: 6px solid #FFD93D;
            transition: transform 0.2s;
            background: linear-gradient(to right, #fff 98%, #fffbf0 100%);
        }
        .diary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-700 font-medium">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm z-20 px-4 py-2 flex justify-between items-center border-b-4 border-yellow-300 border-dashed h-16 shrink-0 relative">
        <div class="flex items-center gap-3 select-none" onclick="app.toggleView('board')">
            <div class="text-3xl filter drop-shadow-sm cursor-pointer hover:scale-110 transition">ğŸ•µï¸</div>
            <div class="hidden sm:block cursor-pointer">
                <h1 class="text-xl text-gray-800 tracking-wide">ä¾¦æ¢æ—¥è®°</h1>
                <p class="text-xs text-gray-400 font-sans" id="date-display">Loading...</p>
            </div>
        </div>

        <!-- ä¸­é—´åˆ‡æ¢å™¨ -->
        <div class="flex bg-gray-100 p-1 rounded-xl absolute left-1/2 transform -translate-x-1/2 shadow-inner">
            <button id="nav-board" onclick="app.toggleView('board')" class="flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white text-blue-600 ring-1 ring-black/5">
                <span>ğŸ¨</span> ç”»æ¿
            </button>
            <button id="nav-diary" onclick="app.toggleView('diary')" class="flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all text-gray-500 hover:bg-gray-200/50">
                <span>ğŸ“–</span> æ—¥è®°
            </button>
        </div>
        
        <!-- å³ä¾§å·¥å…·æ  -->
        <div id="board-tools" class="flex gap-2 items-center">
            <!-- æ¨¡å¼åˆ‡æ¢ï¼šä»…åœ¨ç”»æ¿æ˜¾ç¤º -->
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button id="btn-move" onclick="app.setMode('move')" title="ç§»åŠ¨æ¨¡å¼" class="w-8 h-8 flex items-center justify-center rounded-md bg-white shadow text-blue-600 transition-all text-lg">âœ‹</button>
                <button id="btn-link" onclick="app.setMode('link')" title="è¿çº¿æ¨¡å¼" class="w-8 h-8 flex items-center justify-center rounded-md text-gray-400 hover:text-blue-500 transition-all text-lg">ğŸ”—</button>
            </div>

            <div class="w-px h-6 bg-gray-300 mx-1"></div>

            <button onclick="app.clearBoard()" title="æ¸…ç©º" class="btn-press w-9 h-9 bg-red-50 text-red-500 rounded-full hover:bg-red-100 flex items-center justify-center text-lg border border-red-100">ğŸ—‘ï¸</button>
            <button onclick="app.saveToDiary()" title="ä¿å­˜" class="btn-press px-3 py-1.5 bg-green-400 text-white rounded-full hover:bg-green-500 shadow-lg shadow-green-200 text-sm flex items-center gap-1 border-b-2 border-green-600 active:border-b-0 active:translate-y-[2px]">
                <span>ğŸ’¾</span> å­˜æ—¥è®°
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- è§†å›¾1: ç”»æ¿æ¨¡å¼ -->
        <div id="view-board" class="flex w-full h-full absolute inset-0 z-0">
            <!-- å·¦ä¾§å·¥å…·ç®± -->
            <aside class="w-18 sm:w-20 bg-white shadow-xl flex flex-col items-center py-6 overflow-y-auto z-10 border-r border-gray-100 custom-scroll shrink-0 space-y-8 select-none">
                
                <div class="flex flex-col gap-3 w-full items-center">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">æˆ‘çš„å°é˜Ÿ</div>
                    <div class="sidebar-item w-12 h-12 rounded-xl border-2 border-dashed border-indigo-300 bg-indigo-50 flex flex-col items-center justify-center shadow-sm cursor-pointer"
                         onclick="app.addNode('group', 'ğŸš©', '#e0e7ff')">
                         <span class="text-xl">ğŸš©</span>
                         <span class="text-[9px] text-indigo-500 font-bold">Base</span>
                    </div>
                </div>

                <div class="flex flex-col gap-3 w-full items-center">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">æœ‹å‹ä»¬</div>
                    <button class="sidebar-item w-11 h-11 rounded-full bg-red-100 border-2 border-red-200 flex items-center justify-center text-2xl shadow-sm hover:bg-red-200" 
                         onclick="app.addNode('person', 'ğŸ‘¦', '#FF6B6B')">ğŸ‘¦</button>
                    <button class="sidebar-item w-11 h-11 rounded-full bg-teal-100 border-2 border-teal-200 flex items-center justify-center text-2xl shadow-sm hover:bg-teal-200" 
                         onclick="app.addNode('person', 'ğŸ‘§', '#4ECDC4')">ğŸ‘§</button>
                    <button class="sidebar-item w-11 h-11 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center text-xl text-gray-400 hover:text-blue-500 hover:border-blue-300" 
                         onclick="app.addNode('person', 'SELECT_ME', 'RANDOM')">â•</button>
                </div>

                <div class="flex flex-col gap-3 w-full items-center">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">å‘ç”Ÿäº†å•¥</div>
                    <button class="sidebar-item w-11 h-11 rounded-lg bg-yellow-50 border-2 border-yellow-200 flex items-center justify-center text-2xl shadow-sm hover:bg-yellow-100" 
                         onclick="app.addNode('event', 'âš½', '#ffffff')">âš½</button>
                    <button class="sidebar-item w-11 h-11 rounded-lg bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center text-xl text-gray-400 hover:text-blue-500 hover:border-blue-300" 
                         onclick="app.addNode('event', 'SELECT_ME', '#ffffff')">â•</button>
                </div>
            </aside>

            <!-- ä¸»ç”»å¸ƒ -->
            <main id="canvas-container" class="flex-1 relative overflow-hidden">
                <canvas id="boardCanvas" class="absolute top-0 left-0 block"></canvas>
                
                <!-- æç¤º Toast -->
                <div id="mode-toast" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-5 py-2 rounded-full text-sm shadow-xl opacity-0 transition-opacity pointer-events-none z-20 w-max backdrop-blur-sm flex items-center gap-2">
                    <span id="toast-icon">ğŸ”—</span> <span id="toast-msg">æ¨¡å¼å·²åˆ‡æ¢</span>
                </div>

                <!-- åº•éƒ¨ç®€æ˜“æç¤º (ç§»åŠ¨ç«¯) -->
                <div class="absolute bottom-4 left-0 right-0 text-center pointer-events-none md:hidden opacity-50">
                    <p class="text-xs text-gray-400 bg-white/80 inline-block px-3 py-1 rounded-full backdrop-blur">
                        ğŸ’¡ ç‚¹ä¾§è¾¹æ æ·»åŠ  â€¢ åŒå‡»ä¿®æ”¹
                    </p>
                </div>
            </main>
        </div>

        <!-- è§†å›¾2: æ—¥è®°æœ¬æ¨¡å¼ -->
        <div id="view-diary" class="w-full h-full absolute inset-0 z-10 hidden flex flex-col bg-[#FDFBF7]">
            <div class="p-4 sm:p-8 max-w-4xl mx-auto w-full h-full overflow-y-auto custom-scroll">
                <div class="flex items-end gap-3 mb-8 border-b border-gray-200 pb-4">
                    <h2 class="text-3xl text-gray-800">ğŸ“– å›å¿†å½•</h2>
                    <span class="text-sm text-white bg-orange-400 px-3 py-1 rounded-full font-bold shadow-sm" id="diary-count">0ç¯‡</span>
                </div>
                <div id="diary-list" class="space-y-6 pb-20">
                    <!-- æ—¥è®°å¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
            </div>
        </div>

    </div>

    <!-- æ¨¡æ€æ¡† (é€šç”¨) -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900/40 hidden z-50 flex items-center justify-center backdrop-blur-[2px] px-4 transition-opacity">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl modal-enter border-4 border-white ring-4 ring-blue-50">
            <h2 id="modal-title" class="text-xl text-gray-800 mb-2 flex items-center gap-2">æ ‡é¢˜</h2>
            <p id="modal-desc" class="text-sm text-gray-500 mb-4 leading-relaxed hidden">ç¡®è®¤ï¼Ÿ</p>
            
            <textarea id="modal-input" class="w-full h-24 p-4 border-2 border-gray-200 rounded-xl bg-gray-50 text-lg focus:ring-0 focus:border-blue-400 focus:bg-white focus:outline-none resize-none mb-2 transition-colors placeholder-gray-300"></textarea>
            
            <div id="modal-date-picker" class="hidden mb-6 bg-blue-50 p-3 rounded-xl border border-blue-100">
                <label class="block text-xs text-blue-500 mb-1 font-bold uppercase">ğŸ“… é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-lg bg-white font-bold text-gray-700 focus:outline-none focus:border-blue-400">
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button onclick="app.closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-bold text-sm transition-colors">å–æ¶ˆ</button>
                <button id="modal-action" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold shadow-lg shadow-blue-200 transform active:scale-95 transition-all text-sm">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emoji-overlay" class="fixed inset-0 bg-gray-900/40 hidden z-50 flex items-center justify-center backdrop-blur-[2px] px-4">
        <div class="bg-white rounded-2xl p-4 w-full max-w-sm shadow-2xl max-h-[70vh] flex flex-col modal-enter ring-4 ring-yellow-50">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-lg text-gray-800" id="emoji-title">âœ¨ é€‰æ‹©è´´çº¸</h2>
                <button onclick="document.getElementById('emoji-overlay').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">&times;</button>
            </div>
            <div id="emoji-grid" class="grid grid-cols-5 gap-2 overflow-y-auto custom-scroll p-1 text-center"></div>
        </div>
    </div>

    <script>
        const app = (function() {
            const canvas = document.getElementById('boardCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('canvas-container');
            
            // --- é…ç½® ---
            const STORAGE_KEY_DRAFT = 'kids_diary_draft_v4'; 
            const STORAGE_KEY_HISTORY = 'kids_diary_history_v1';
            const ME_ID = 'USER_ME';
            
            // è§£å†³ Retina å±å¹•æ¨¡ç³Šé—®é¢˜
            let dpr = window.devicePixelRatio || 1;

            const EMOJI_LIB = {
                person: ["ğŸ‘¶","ğŸ‘§","ğŸ§’","ğŸ‘¦","ğŸ‘©","ğŸ§‘","ğŸ‘¨","ğŸ‘µ","ğŸ§“","ğŸ‘´","ğŸ‘®","ğŸ‘©â€âš•ï¸","ğŸ§‘â€ğŸ«","ğŸ‘¨â€ğŸ³","ğŸ¦¸","ğŸ§™","ğŸ§š","ğŸ‘»","ğŸ¤–","ğŸ‘¸","ğŸ¶","ğŸ±"],
                event: ["âš½","ğŸ€","ğŸ¨","ğŸ¬","ğŸ®","ğŸ“š","ğŸ«","ğŸ¥ª","ğŸ‚","ğŸ","ğŸ“±","ğŸšŒ","ğŸ’Š","ğŸ§¹","ğŸ›’","ğŸ–ï¸","ğŸ¥","ğŸ¢","ğŸ§¸"],
                fruit: ["ğŸŠ","ğŸ","ğŸ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥"],
                group: ["ğŸš©","ğŸ ","ğŸ•ï¸","ğŸš¤","ğŸš€","ğŸ°","ğŸŸï¸","ğŸ«","ğŸŒ³"]
            };

            let nodes = [];
            let links = [];
            let width, height; // CSS åƒç´ å°ºå¯¸
            let mode = 'move';
            
            // äº¤äº’çŠ¶æ€
            const state = {
                draggingNode: null,
                connectingNode: null,
                hoverNode: null, // é¼ æ ‡æ‚¬åœçš„èŠ‚ç‚¹
                hoverLink: null, // é¼ æ ‡æ‚¬åœçš„è¿çº¿ (æ–°åŠŸèƒ½)
                dragOffset: { x: 0, y: 0 },
                mouseX: 0, mouseY: 0,
                lastTouchTime: 0,
                longPressTimer: null
            };

            // é¢œè‰²æ± 
            const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#FF9F43', '#A3CB38', '#f368e0'];

            function init() {
                resize();
                window.addEventListener('resize', resize);
                setupEvents();
                updateDateDisplay();
                loadDraft();
                loadHistory();
                ensureMeNode();
                requestAnimationFrame(animate);
            }

            function ensureMeNode() {
                if (!nodes.find(n => n.id === ME_ID)) {
                    nodes.push({
                        id: ME_ID,
                        x: width / 2,
                        y: height / 2,
                        type: 'person',
                        emoji: 'ğŸ•µï¸',
                        color: '#FFD93D',
                        label: 'æˆ‘',
                        scale: 1 // åŠ¨ç”»ç¼©æ”¾å› å­
                    });
                }
            }

            function updateDateDisplay() {
                const now = new Date();
                const options = { weekday: 'short', month: 'numeric', day: 'numeric' };
                document.getElementById('date-display').innerText = now.toLocaleDateString('zh-CN', options);
                document.getElementById('date-input').valueAsDate = new Date();
            }

            function resize() {
                width = container.clientWidth;
                height = container.clientHeight;
                
                // å…³é”®ä¿®å¤ï¼šå¤„ç† High DPI
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                
                ctx.scale(dpr, dpr);

                // ç®€å•çš„è¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢ Resize åèŠ‚ç‚¹æ¶ˆå¤±
                nodes.forEach(n => {
                    n.x = Math.min(Math.max(n.x, 30), width - 30);
                    n.y = Math.min(Math.max(n.y, 30), height - 30);
                });
            }

            function toggleView(viewName) {
                const board = document.getElementById('view-board');
                const diary = document.getElementById('view-diary');
                const tools = document.getElementById('board-tools');
                const btnBoard = document.getElementById('nav-board');
                const btnDiary = document.getElementById('nav-diary');

                if (viewName === 'board') {
                    board.classList.remove('hidden');
                    diary.classList.add('hidden');
                    tools.classList.remove('hidden');
                    btnBoard.className = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white text-blue-600 ring-1 ring-black/5 font-bold";
                    btnDiary.className = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all text-gray-500 hover:bg-gray-200/50";
                } else {
                    board.classList.add('hidden');
                    diary.classList.remove('hidden');
                    tools.classList.add('hidden');
                    btnDiary.className = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white text-blue-600 ring-1 ring-black/5 font-bold";
                    btnBoard.className = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all text-gray-500 hover:bg-gray-200/50";
                    renderDiaryList(); 
                }
            }

            function setMode(newMode) {
                mode = newMode;
                const btnMove = document.getElementById('btn-move');
                const btnLink = document.getElementById('btn-link');
                const toast = document.getElementById('mode-toast');
                const toastMsg = document.getElementById('toast-msg');
                const toastIcon = document.getElementById('toast-icon');
                
                const activeClass = "bg-white shadow text-blue-600 ring-1 ring-blue-100 transform scale-105";
                const inactiveClass = "text-gray-400 hover:text-blue-500";

                if (mode === 'move') {
                    btnMove.className = `w-8 h-8 flex items-center justify-center rounded-md transition-all text-lg ${activeClass}`;
                    btnLink.className = `w-8 h-8 flex items-center justify-center rounded-md transition-all text-lg ${inactiveClass}`;
                    container.classList.remove('mode-link');
                    toastMsg.innerText = "ç§»åŠ¨æ¨¡å¼"; toastIcon.innerText = "âœ‹";
                } else {
                    btnLink.className = `w-8 h-8 flex items-center justify-center rounded-md transition-all text-lg ${activeClass}`;
                    btnMove.className = `w-8 h-8 flex items-center justify-center rounded-md transition-all text-lg ${inactiveClass}`;
                    container.classList.add('mode-link');
                    toastMsg.innerText = "è¿çº¿æ¨¡å¼"; toastIcon.innerText = "ğŸ”—";
                }

                toast.style.opacity = '1';
                setTimeout(() => toast.style.opacity = '0', 1500);
            }

            // --- ç»˜å›¾æ ¸å¿ƒ ---
            function animate() {
                ctx.clearRect(0, 0, width, height);

                // ç»˜åˆ¶è¿çº¿
                links.forEach(link => drawLink(link));
                
                // ç»˜åˆ¶æ­£åœ¨æ‹–æ‹½çš„ä¸´æ—¶çº¿
                if (state.connectingNode) {
                    drawCurve(state.connectingNode.x, state.connectingNode.y, state.mouseX, state.mouseY, '#4299e1', true);
                }

                // ç»˜åˆ¶èŠ‚ç‚¹
                nodes.forEach(node => drawNode(node));

                requestAnimationFrame(animate);
            }

            function drawNode(node) {
                const isHover = state.hoverNode === node;
                const isDragging = state.draggingNode === node;
                const isMe = node.id === ME_ID;
                
                // ç®€å•çš„å¼¹æ€§åŠ¨ç”»æ’å€¼
                const targetScale = isDragging || isHover ? 1.15 : 1.0;
                node.scale = node.scale ? node.scale * 0.8 + targetScale * 0.2 : 1.0;

                ctx.save();
                ctx.translate(node.x, node.y);
                ctx.scale(node.scale, node.scale);

                // é˜´å½±
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = isDragging ? 20 : 10;
                ctx.shadowOffsetY = isDragging ? 10 : 5;

                // å½¢çŠ¶
                ctx.beginPath();
                if (node.type === 'group') {
                    ctx.roundRect(-45, -45, 90, 90, 16);
                    ctx.setLineDash([8, 6]);
                } else if (node.type === 'event') {
                    ctx.roundRect(-35, -35, 70, 70, 14);
                } else {
                    ctx.arc(0, 0, 36, 0, Math.PI * 2);
                }

                ctx.fillStyle = node.color;
                ctx.fill();
                
                // æè¾¹
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#fff';
                if (isMe) {
                    ctx.strokeStyle = '#FFD93D'; // é‡‘è‰²è¾¹æ¡†
                } else if (state.connectingNode && isHover && state.connectingNode !== node) {
                    ctx.strokeStyle = '#4299e1'; // è¿çº¿å¸é™„é«˜äº®
                }
                ctx.stroke();
                ctx.setLineDash([]); // é‡ç½®è™šçº¿

                // Emoji
                ctx.shadowColor = 'transparent';
                ctx.font = node.type === 'group' ? "48px Apple Color Emoji, Segoe UI Emoji" : "40px Apple Color Emoji, Segoe UI Emoji";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                // å¾®è°ƒ Emoji å‚ç›´ä½ç½®
                const yOffset = navigator.platform.indexOf('Win') > -1 ? 4 : 2; 
                ctx.fillText(node.emoji, 0, yOffset);

                // æ ‡ç­¾
                drawLabel(node.label, 0, node.type === 'group' ? 58 : 50, true, node.color);

                ctx.restore();
            }

            function drawLink(link) {
                const s = nodes.find(n => n.id === link.source);
                const t = nodes.find(n => n.id === link.target);
                if (!s || !t) return;

                const isHover = state.hoverLink === link;
                const color = isHover ? '#4299e1' : '#CBD5E0';
                const lineWidth = isHover ? 5 : 3;

                drawCurve(s.x, s.y, t.x, t.y, color, false, lineWidth);

                // æ ‡ç­¾ (ç»˜åˆ¶åœ¨æ›²çº¿ä¸­ç‚¹)
                if (link.label) {
                    const mid = getCurveMidPoint(s.x, s.y, t.x, t.y);
                    ctx.save();
                    ctx.translate(mid.x, mid.y);
                    drawLabel(link.label, 0, 0, false, isHover ? '#ebf8ff' : '#fff');
                    ctx.restore();
                }
            }

            function drawCurve(x1, y1, x2, y2, color, dashed = false, width = 3) {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                
                // è´å¡å°”æ›²çº¿æ§åˆ¶ç‚¹ï¼Œä½¿çº¿æ¡ç¨å¾®å¼¯æ›²
                const dx = x2 - x1;
                const dy = y2 - y1;
                const dist = Math.sqrt(dx*dx + dy*dy);
                // åŠ¨æ€æ›²ç‡ï¼šè·ç¦»è¶Šè¿œå¼¯æ›²è¶Šå°‘ï¼Œé¿å…è·‘å‡ºå±å¹•
                const factor = 0.2; 
                const cpX = (x1 + x2) / 2 - dy * factor * 0.5; // ç¨å¾®åç§»
                const cpY = (y1 + y2) / 2 + dx * factor * 0.5;

                ctx.quadraticCurveTo(cpX, cpY, x2, y2);
                
                ctx.lineCap = 'round';
                ctx.lineWidth = width;
                ctx.strokeStyle = color;
                if (dashed) ctx.setLineDash([8, 8]);
                else ctx.setLineDash([]);
                ctx.stroke();
                return { cpX, cpY };
            }

            function getCurveMidPoint(x1, y1, x2, y2) {
                // ç®€åŒ–ä¼°ç®—ï¼Œç›´æ¥å–ç›´çº¿ä¸­ç‚¹åç§»ä¸€ç‚¹ï¼Œç”¨äºæ”¾æ–‡å­—è¶³å¤Ÿäº†
                // å¦‚æœéœ€è¦ç²¾ç¡®è´å¡å°”ä¸­ç‚¹å…¬å¼å¤ªå¤æ‚ï¼Œè¿™é‡Œåšä¸ªè§†è§‰æ¬ºéª—
                const dx = x2 - x1;
                const dy = y2 - y1;
                const factor = 0.2;
                const midX = (x1 + x2) / 2 - dy * factor * 0.25; 
                const midY = (y1 + y2) / 2 + dx * factor * 0.25;
                return { x: midX, y: midY };
            }

            function drawLabel(text, x, y, isNode, bgOverride) {
                ctx.font = "bold 14px 'ZCOOL KuaiLe', sans-serif";
                const metrics = ctx.measureText(text);
                const w = metrics.width + 16;
                const h = 26;
                
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetY = 2;
                
                ctx.fillStyle = bgOverride || "rgba(255, 255, 255, 0.95)";
                ctx.beginPath();
                const startY = isNode ? y : y - h/2;
                ctx.roundRect(x - w/2, startY, w, h, 8);
                ctx.fill();
                
                // æ–‡å­—é¢œè‰²
                ctx.fillStyle = "#4b5563";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowColor = 'transparent';
                ctx.fillText(text, x, startY + h/2 + 1);
                ctx.restore();
            }

            // --- äº‹ä»¶å¤„ç† ---
            function getPointerPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { 
                    x: (clientX - rect.left), // è¿™é‡Œçš„åæ ‡æ˜¯ CSS åƒç´ 
                    y: (clientY - rect.top)
                };
            }

            // å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨ isPointInStroke è¿›è¡Œæ›´ç²¾ç¡®ä¸”æ˜“ç”¨çš„è¿çº¿åˆ¤å®š
            function checkHover(x, y) {
                // ä¸ºäº†æ£€æµ‹ï¼Œéœ€è¦é‡ç»˜è·¯å¾„ (ä¸å¯è§)
                // 1. æ£€æŸ¥è¿çº¿ (ä¼˜å…ˆåº¦ä½)
                state.hoverLink = null;
                // é€†åºéå†ï¼Œè®©ä¸Šå±‚çš„çº¿ä¼˜å…ˆ
                for (let i = links.length - 1; i >= 0; i--) {
                    const l = links[i];
                    const s = nodes.find(n => n.id === l.source);
                    const t = nodes.find(n => n.id === l.target);
                    if (!s || !t) continue;

                    // é‡æ–°æ„å»ºè·¯å¾„
                    drawCurve(s.x, s.y, t.x, t.y, 'transparent', false, 15); // 15px å®½åº¦çš„æ£€æµ‹åŒºåŸŸ
                    if (ctx.isPointInStroke(x * dpr, y * dpr)) { // æ³¨æ„ï¼šisPointInStroke ä½¿ç”¨ Canvas å†…éƒ¨åˆ†è¾¨ç‡
                        state.hoverLink = l;
                        break; 
                    }
                }

                // 2. æ£€æŸ¥èŠ‚ç‚¹ (ä¼˜å…ˆåº¦é«˜ï¼Œè¦†ç›–è¿çº¿)
                state.hoverNode = null;
                for (let i = nodes.length - 1; i >= 0; i--) {
                    const n = nodes[i];
                    const r = n.type === 'group' ? 50 : 40; // ç‚¹å‡»åŒºåŸŸç•¥å¤§äºç»˜åˆ¶åŒºåŸŸ
                    if (Math.abs(x - n.x) < r && Math.abs(y - n.y) < r) {
                        state.hoverNode = n;
                        state.hoverLink = null; // é€‰ä¸­èŠ‚ç‚¹æ—¶æ¸…é™¤è¿çº¿é€‰ä¸­
                        break;
                    }
                }

                container.style.cursor = state.hoverNode ? 'grab' : (state.hoverLink ? 'pointer' : (mode==='link' ? 'crosshair' : 'default'));
            }

            function handleStart(e) {
                // e.preventDefault(); // ä¸èƒ½å…¨é˜»æ­¢ï¼Œå¦åˆ™è¾“å…¥æ¡†æ— æ³•å¤±ç„¦ï¼Œä½†æ­¤å¤„ Canvas éœ€è¦é˜»æ­¢æ»šåŠ¨
                if(e.target === canvas) e.preventDefault(); 
                
                const { x, y } = getPointerPos(e);
                checkHover(x, y);

                // åŒå‡»æ£€æµ‹
                const now = Date.now();
                if (now - state.lastTouchTime < 300) {
                    handleDoubleClick(e);
                    return;
                }
                state.lastTouchTime = now;

                if (state.hoverNode) {
                    if (mode === 'link' || e.shiftKey) {
                        state.connectingNode = state.hoverNode;
                    } else {
                        state.draggingNode = state.hoverNode;
                        state.dragOffset = { x: x - state.hoverNode.x, y: y - state.hoverNode.y };
                    }
                } else {
                    // é•¿æŒ‰é€»è¾‘ (ä¾‹å¦‚ï¼šæ¸…ç©ºé€‰ä¸­)
                }
                
                state.mouseX = x; state.mouseY = y;
            }

            function handleMove(e) {
                if(e.target === canvas) e.preventDefault();
                const { x, y } = getPointerPos(e);
                state.mouseX = x; state.mouseY = y;
                
                if (state.draggingNode) {
                    // è¾¹ç•Œé™åˆ¶ï¼šä¸è®©èŠ‚ç‚¹è·‘å‡ºå»
                    const margin = 30;
                    state.draggingNode.x = Math.max(margin, Math.min(width - margin, x - state.dragOffset.x));
                    state.draggingNode.y = Math.max(margin, Math.min(height - margin, y - state.dragOffset.y));
                } else if (state.connectingNode) {
                    // ä»…æ›´æ–° state.mouseX/Y ç”¨äºç»˜åˆ¶è¿çº¿åŠ¨ç”»
                } else {
                    checkHover(x, y);
                }
            }

            function handleEnd(e) {
                if (state.connectingNode) {
                    // ç»“æŸè¿çº¿
                    checkHover(state.mouseX, state.mouseY); // é‡æ–°æ£€æµ‹é‡Šæ”¾ä½ç½®ä¸‹çš„èŠ‚ç‚¹
                    const target = state.hoverNode;
                    
                    if (target && target !== state.connectingNode) {
                        const exists = links.find(l => 
                            (l.source === state.connectingNode.id && l.target === target.id) || 
                            (l.source === target.id && l.target === state.connectingNode.id)
                        );
                        
                        if (!exists) {
                            links.push({ 
                                id: Date.now().toString(), 
                                source: state.connectingNode.id, 
                                target: target.id, 
                                label: "äº’åŠ¨" 
                            });
                            saveDraft();
                        }
                    }
                    state.connectingNode = null;
                }
                
                if (state.draggingNode) {
                    state.draggingNode = null;
                    saveDraft();
                }
            }

            function handleDoubleClick(e) {
                if (state.hoverNode) {
                    const n = state.hoverNode;
                    if (n.id === ME_ID) {
                        showEmojiPicker('fruit', (emoji) => { n.emoji = emoji; saveDraft(); });
                    } else {
                        showDialog({
                            title: "âœï¸ å®ƒæ˜¯è°ï¼Ÿ",
                            inputValue: n.label,
                            onConfirm: (val) => { 
                                if(val) { n.label = val; saveDraft(); return true; } 
                            }
                        });
                    }
                } else if (state.hoverLink) {
                    const l = state.hoverLink;
                    showDialog({
                        title: "âœï¸ å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ",
                        inputValue: l.label,
                        onConfirm: (val) => { 
                            if(val) { l.label = val; saveDraft(); return true; }
                        }
                    });
                }
            }
            
            // å³é”®èœå•
            function handleContextMenu(e) {
                e.preventDefault();
                const { x, y } = getPointerPos(e);
                checkHover(x, y);

                if (state.hoverNode) {
                    if (state.hoverNode.id === ME_ID) return;
                    showDialog({
                        title: "ğŸ—‘ï¸ åˆ é™¤",
                        desc: `è¦è®© "${state.hoverNode.label}" æ¶ˆå¤±å—ï¼Ÿ`,
                        isConfirm: true,
                        onConfirm: () => {
                            nodes = nodes.filter(n => n.id !== state.hoverNode.id);
                            links = links.filter(l => l.source !== state.hoverNode.id && l.target !== state.hoverNode.id);
                            saveDraft();
                            state.hoverNode = null;
                            return true;
                        }
                    });
                } else if (state.hoverLink) {
                    showDialog({
                        title: "ğŸ—‘ï¸ æ–­å¼€è¿æ¥",
                        desc: "è¦åˆ‡æ–­è¿™æ¡è¿çº¿å—ï¼Ÿ",
                        isConfirm: true,
                        onConfirm: () => {
                            links = links.filter(l => l.id !== state.hoverLink.id);
                            saveDraft();
                            state.hoverLink = null;
                            return true;
                        }
                    });
                }
            }

            function setupEvents() {
                // æŒ‡é’ˆäº‹ä»¶ (Pointer Events) ç»Ÿä¸€å¤„ç†é¼ æ ‡å’Œè§¦æ‘¸
                // ä½†ä¸ºäº†å…¼å®¹æ€§ï¼Œä»ä½¿ç”¨ mouse/touch åˆ†ç¦»ï¼Œæˆ–æ·»åŠ  touch-action css
                canvas.addEventListener('mousedown', handleStart);
                canvas.addEventListener('mousemove', handleMove);
                canvas.addEventListener('mouseup', handleEnd);
                canvas.addEventListener('mouseleave', () => { state.draggingNode = null; state.connectingNode = null; });
                
                canvas.addEventListener('touchstart', handleStart, {passive: false});
                canvas.addEventListener('touchmove', handleMove, {passive: false});
                canvas.addEventListener('touchend', handleEnd);
                
                canvas.addEventListener('contextmenu', handleContextMenu);
            }

            // --- èŠ‚ç‚¹æ“ä½œ (ä¼˜åŒ–ä¸ºç‚¹å‡»æ·»åŠ ï¼Œè€Œéæ‹–æ‹½) ---
            function addNode(type, emoji, color) {
                if (emoji === 'SELECT_ME') {
                    showEmojiPicker(type, (selectedEmoji) => {
                        createNode(type, selectedEmoji, type === 'person' ? (color === 'RANDOM' ? getRandomColor() : color) : '#ffffff');
                    });
                } else {
                    createNode(type, emoji, color);
                }
                
                // ç§»åŠ¨ç«¯ä½“éªŒï¼šè‡ªåŠ¨å…³é—­ä¾§è¾¹æ ï¼ˆå¦‚æœä»¥ååšæˆæŠ½å±‰å¼ï¼‰
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) navigator.vibrate(50);
            }

            function getRandomColor() { return COLORS[Math.floor(Math.random() * COLORS.length)]; }

            function createNode(type, emoji, color) {
                // æ”¾ç½®åœ¨ç”»å¸ƒä¸­å¿ƒï¼Œå¸¦ä¸€ç‚¹éšæœºåç§»
                const x = width / 2 + (Math.random() * 60 - 30);
                const y = height / 2 + (Math.random() * 60 - 30);
                
                const id = Date.now().toString(36) + Math.random().toString(36).slice(2);
                let label = "æ–°äº‹ç‰©";
                if (type === 'person') label = "æ–°æœ‹å‹";
                if (type === 'group') label = "åŸºåœ°";
                
                nodes.push({ id, x, y, type, emoji, color, label, scale: 0 }); // scale 0 for pop-in animation
                saveDraft();
            }

            // --- æ¨¡æ€æ¡†é€»è¾‘ (ä¿®å¤ Bug) ---
            let currentConfirmCallback = null;

            function showDialog({ title, desc, inputValue, onConfirm, isConfirm }) {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const descEl = document.getElementById('modal-desc');
                const inputEl = document.getElementById('modal-input');
                const dateEl = document.getElementById('modal-date-picker');
                const btn = document.getElementById('modal-action');
                
                overlay.classList.remove('hidden');
                titleEl.innerText = title;
                
                if (isConfirm) {
                    inputEl.classList.add('hidden');
                    dateEl.classList.add('hidden');
                    descEl.classList.remove('hidden');
                    descEl.innerText = desc;
                } else {
                    // æ™®é€šè¾“å…¥æ¨¡å¼
                    descEl.classList.add('hidden');
                    dateEl.classList.add('hidden');
                    inputEl.classList.remove('hidden');
                    inputEl.value = inputValue || "";
                    setTimeout(() => inputEl.focus(), 100);
                }

                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ (é˜²æ­¢å¤šæ¬¡ç»‘å®š)
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.onclick = () => {
                    if (onConfirm) {
                        const result = onConfirm(inputEl.value);
                        // åªæœ‰å›è°ƒè¿”å› true (æˆ–ä¸è¿”å› false) æ—¶æ‰å…³é—­
                        if (result !== false) closeModal();
                    } else {
                        closeModal();
                    }
                };
            }

            function closeModal() {
                document.getElementById('modal-overlay').classList.add('hidden');
            }

            // --- æ—¥è®°åŠŸèƒ½ ---
            let diaryHistory = [];

            function saveToDiary() {
                // ç‰¹æ®Šæ¨¡æ€æ¡†é€»è¾‘
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const descEl = document.getElementById('modal-desc');
                const inputEl = document.getElementById('modal-input');
                const datePicker = document.getElementById('modal-date-picker');
                const dateInput = document.getElementById('date-input');
                const btn = document.getElementById('modal-action');

                overlay.classList.remove('hidden');
                titleEl.innerText = "ğŸ’¾ ä¿å­˜å›å¿†";
                inputEl.classList.add('hidden');
                descEl.classList.remove('hidden');
                descEl.innerText = "æˆ‘ä»¬è¦æŠŠä»Šå¤©çš„ä¾¦æ¢ç”»æ¿å­˜èµ·æ¥å—ï¼Ÿ";
                datePicker.classList.remove('hidden');
                
                // æ›¿æ¢æŒ‰é’®é˜²æ­¢é‡å¤ç»‘å®š
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.onclick = () => {
                    const date = dateInput.value;
                    if (!date) return alert("è¯·é€‰æ‹©æ—¥æœŸï¼");
                    
                    const snapshot = {
                        nodes: JSON.parse(JSON.stringify(nodes)),
                        links: JSON.parse(JSON.stringify(links))
                    };

                    const existingIdx = diaryHistory.findIndex(d => d.date === date);
                    if (existingIdx >= 0) {
                        // åˆå¹¶é€»è¾‘ï¼šç®€å•çš„è¦†ç›–æˆ–è¿½åŠ ï¼Ÿè¿™é‡Œé€‰æ‹©è¦†ç›–å½“å‰æ—¥è®°çš„å¿«ç…§ï¼Œä½†é€šå¸¸åº”è¯¥æ›´æ™ºèƒ½
                        // ç®€åŒ–å¤„ç†ï¼šæ›´æ–°è¯¥æ—¥å†…å®¹
                        diaryHistory[existingIdx] = { ...snapshot, date, timestamp: Date.now() };
                    } else {
                        diaryHistory.unshift({ ...snapshot, date, timestamp: Date.now() });
                    }
                    
                    // æ’åº
                    diaryHistory.sort((a,b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(diaryHistory));
                    
                    closeModal();
                    
                    // é£å…¥æ—¥è®°æœ¬çš„åŠ¨ç”»åé¦ˆ (å¯é€‰)
                    app.toggleView('diary');
                };
            }

            function renderDiaryList() {
                const list = document.getElementById('diary-list');
                const count = document.getElementById('diary-count');
                list.innerHTML = '';
                count.innerText = diaryHistory.length + "ç¯‡";

                if (diaryHistory.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 opacity-50"><div class="text-6xl mb-4">ğŸ“­</div><p>è¿˜æ²¡æœ‰æ—¥è®°å“¦ï¼Œå¿«å»ç”»æ¿è®°å½•å§ï¼</p></div>`;
                    return;
                }

                diaryHistory.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "diary-card p-5 rounded-2xl shadow-sm border border-gray-100 relative";
                    
                    // åˆ†æå†…å®¹
                    const meNode = item.nodes.find(n => n.id === ME_ID);
                    const actionCount = item.links.length;
                    const peopleCount = item.nodes.filter(n => n.type === 'person' && n.id !== ME_ID).length;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-md">${item.date}</span>
                                </h3>
                            </div>
                            <button onclick="app.deleteDiary(${idx})" class="text-gray-300 hover:text-red-500 transition px-2 text-xl">&times;</button>
                        </div>
                        <div class="text-gray-600 text-sm mb-4 bg-white/50 p-3 rounded-lg border border-gray-50">
                            ğŸ•µï¸ å‘ç°äº† ${peopleCount} ä¸ªæœ‹å‹ï¼Œè®°å½•äº† ${actionCount} ä¸ªäº’åŠ¨ã€‚
                        </div>
                        <div class="flex justify-end">
                            <button onclick="app.loadDiary(${idx})" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 transition flex items-center gap-1">
                                <span>ğŸ‘€</span> æŸ¥çœ‹å½“æ—¶çš„ç”»æ¿
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            function loadDiary(idx) {
                showDialog({
                    title: "â³ æ—¶å…‰å€’æµ",
                    desc: "ç¡®å®šè¦å›åˆ°è¿™ä¸€å¤©å—ï¼Ÿå½“å‰ç”»æ¿ä¸Šæ²¡ä¿å­˜çš„å†…å®¹ä¼šæ¶ˆå¤±å“¦ã€‚",
                    isConfirm: true,
                    onConfirm: () => {
                        const item = diaryHistory[idx];
                        nodes = JSON.parse(JSON.stringify(item.nodes));
                        links = JSON.parse(JSON.stringify(item.links));
                        saveDraft();
                        toggleView('board');
                        return true;
                    }
                });
            }

            function deleteDiary(idx) {
                showDialog({
                    title: "ğŸ—‘ï¸ æ’•æ‰è¿™é¡µ",
                    desc: "ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ",
                    isConfirm: true,
                    onConfirm: () => {
                        diaryHistory.splice(idx, 1);
                        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(diaryHistory));
                        renderDiaryList();
                        return true;
                    }
                });
            }

            function clearBoard() {
                showDialog({
                    title: "ğŸ§¹ å¤§æ‰«é™¤",
                    desc: "ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ",
                    isConfirm: true,
                    onConfirm: () => {
                        nodes = []; links = []; ensureMeNode(); saveDraft(); return true;
                    }
                });
            }

            // --- é€šç”¨ ---
            function showEmojiPicker(type, callback) {
                const el = document.getElementById('emoji-overlay');
                const grid = document.getElementById('emoji-grid');
                const title = document.getElementById('emoji-title');
                
                el.classList.remove('hidden');
                grid.innerHTML = '';
                title.innerText = type === 'fruit' ? "ğŸŠ å˜èº«" : "âœ¨ é€‰æ‹©è´´çº¸";
                
                const list = EMOJI_LIB[type] || EMOJI_LIB['person'];
                list.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.innerText = emoji;
                    btn.className = "text-3xl h-12 w-12 flex items-center justify-center hover:bg-gray-100 rounded-xl transition active:scale-90";
                    btn.onclick = () => {
                        callback(emoji);
                        el.classList.add('hidden');
                    }
                    grid.appendChild(btn);
                });
            }

            function saveDraft() {
                localStorage.setItem(STORAGE_KEY_DRAFT, JSON.stringify({ nodes, links }));
            }
            function loadDraft() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY_DRAFT);
                    if(raw) {
                        const d = JSON.parse(raw);
                        nodes = d.nodes || []; links = d.links || [];
                    }
                } catch(e) {}
            }
            function loadHistory() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
                    if(raw) diaryHistory = JSON.parse(raw);
                } catch(e) {}
            }

            return {
                init, toggleView, setMode, addNode,
                saveToDiary, loadDiary, deleteDiary, clearBoard, closeModal
            };
        })();

        window.onload = app.init;
    </script>
</body>
</html>
