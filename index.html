<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„ç¤¾äº¤ä¾¦æ¢æ—¥è®° (ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        body {
            font-family: "ZCOOL KuaiLe", "YouYuan", "å¹¼åœ†", sans-serif;
            background-color: #f0f4f8;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            touch-action: none;
        }

        input, textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
            touch-action: auto !important;
        }

        #canvas-container {
            background-color: #F9F7F2;
            background-image: radial-gradient(#CBD5E0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }
        #canvas-container.mode-link { cursor: crosshair; }

        .sidebar-item {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            touch-action: none;
            position: relative;
        }
        .sidebar-item:active { transform: scale(0.9); }
        .sidebar-item:hover { transform: scale(1.05); }

        .btn-press:active { transform: scale(0.95); }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }

        .diary-card {
            border-left: 6px solid #FFD93D;
            transition: transform 0.2s;
            background: linear-gradient(to right, #fff 98%, #fffbf0 100%);
        }
        .diary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
        .mobile-nav-btn.active {
            color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-700 font-medium">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm z-20 px-3 sm:px-4 py-2 flex justify-between items-center border-b-4 border-yellow-300 border-dashed h-16 shrink-0 relative">
        <!-- å·¦ä¾§ï¼šLogo å’Œ è®¾ç½® -->
        <div class="flex items-center gap-2 select-none">
            <div class="text-3xl filter drop-shadow-sm cursor-pointer hover:scale-110 transition" onclick="app.showSettings()">ğŸ•µï¸</div>
            <div class="hidden sm:block cursor-pointer" onclick="app.toggleView('board')">
                <h1 class="text-xl text-gray-800 tracking-wide">ä¾¦æ¢æ—¥è®°</h1>
                <p class="text-xs text-gray-400 font-sans" id="date-display">Loading...</p>
            </div>
            <!-- è®¾ç½®/å¤‡ä»½æŒ‰é’® -->
            <button onclick="app.showSettings()" class="sm:hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500">âš™ï¸</button>
        </div>

        <!-- ä¸­é—´åˆ‡æ¢å™¨ (ä»…æ¡Œé¢ç«¯æ˜¾ç¤º) -->
        <div class="hidden md:flex bg-gray-100 p-1 rounded-xl absolute left-1/2 transform -translate-x-1/2 shadow-inner">
            <button id="nav-board-desktop" onclick="app.toggleView('board')" class="flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white text-blue-600 ring-1 ring-black/5">
                <span>ğŸ¨</span> ç”»æ¿
            </button>
            <button id="nav-diary-desktop" onclick="app.toggleView('diary')" class="flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all text-gray-500 hover:bg-gray-200/50">
                <span>ğŸ“–</span> æ—¥è®°
            </button>
        </div>
        
        <!-- å³ä¾§å·¥å…·æ  (å§‹ç»ˆæ˜¾ç¤ºï¼Œå› ä¸ºNavåœ¨ç§»åŠ¨ç«¯ç§»åˆ°åº•éƒ¨äº†) -->
        <div id="board-tools" class="flex gap-2 items-center">
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button id="btn-move" onclick="app.setMode('move')" title="ç§»åŠ¨æ¨¡å¼" class="w-9 h-9 flex items-center justify-center rounded-md bg-white shadow text-blue-600 transition-all text-xl">âœ‹</button>
                <button id="btn-link" onclick="app.setMode('link')" title="è¿çº¿æ¨¡å¼" class="w-9 h-9 flex items-center justify-center rounded-md text-gray-400 hover:text-blue-500 transition-all text-xl">ğŸ”—</button>
            </div>

            <div class="w-px h-6 bg-gray-300 mx-1"></div>

            <button onclick="app.clearBoard()" title="æ¸…ç©º" class="btn-press w-9 h-9 bg-red-50 text-red-500 rounded-full hover:bg-red-100 flex items-center justify-center text-lg border border-red-100">ğŸ—‘ï¸</button>
            <button onclick="app.saveToDiary()" title="ä¿å­˜" class="btn-press px-3 py-1.5 bg-green-400 text-white rounded-full hover:bg-green-500 shadow-lg shadow-green-200 text-sm flex items-center gap-1 border-b-2 border-green-600 active:border-b-0 active:translate-y-[2px]">
                <span>ğŸ’¾</span> <span class="hidden sm:inline">å­˜æ—¥è®°</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- è§†å›¾1: ç”»æ¿æ¨¡å¼ -->
        <div id="view-board" class="flex w-full h-full absolute inset-0 z-0">
            <!-- å·¦ä¾§å·¥å…·ç®± -->
            <aside class="w-16 sm:w-20 bg-white shadow-xl flex flex-col items-center py-4 sm:py-6 overflow-y-auto z-10 border-r border-gray-100 custom-scroll shrink-0 space-y-6 select-none pb-24">
                
                <div class="flex flex-col gap-2 w-full items-center group relative">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                        å°é˜Ÿ <span class="text-gray-300 cursor-pointer bg-gray-100 rounded-full w-3 h-3 flex items-center justify-center text-[8px]" onclick="alert('ã€æˆ‘çš„å°é˜Ÿã€‘æ˜¯ä¸€ä¸ªåŸºåœ°å›¾æ ‡ã€‚ä½ å¯ä»¥æŠŠå®ƒæ‹–åˆ°ä¸­é—´ï¼Œç„¶åæŠŠåŒä¸€ç±»æœ‹å‹ï¼ˆæ¯”å¦‚å­¦æ ¡åŒå­¦ï¼‰æ”¾åœ¨å®ƒå‘¨å›´ï¼Œå‡è£…ä»–ä»¬åœ¨å¼€ä¼šï¼')">?</span>
                    </div>
                    <div class="sidebar-item w-11 h-11 rounded-xl border-2 border-dashed border-indigo-300 bg-indigo-50 flex flex-col items-center justify-center shadow-sm cursor-pointer"
                         onclick="app.addNode('group', 'ğŸš©', '#e0e7ff')">
                         <span class="text-xl">ğŸš©</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2 w-full items-center">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">æœ‹å‹</div>
                    <button class="sidebar-item w-10 h-10 rounded-full bg-red-100 border-2 border-red-200 flex items-center justify-center text-xl shadow-sm hover:bg-red-200" 
                         onclick="app.addNode('person', 'ğŸ‘¦', '#FF6B6B')">ğŸ‘¦</button>
                    <button class="sidebar-item w-10 h-10 rounded-full bg-teal-100 border-2 border-teal-200 flex items-center justify-center text-xl shadow-sm hover:bg-teal-200" 
                         onclick="app.addNode('person', 'ğŸ‘§', '#4ECDC4')">ğŸ‘§</button>
                    <button class="sidebar-item w-10 h-10 rounded-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center text-lg text-gray-400 hover:text-blue-500 hover:border-blue-300" 
                         onclick="app.addNode('person', 'SELECT_ME', 'RANDOM')">â•</button>
                </div>

                <div class="flex flex-col gap-2 w-full items-center">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">äº‹ä»¶</div>
                    <button class="sidebar-item w-10 h-10 rounded-lg bg-yellow-50 border-2 border-yellow-200 flex items-center justify-center text-xl shadow-sm hover:bg-yellow-100" 
                         onclick="app.addNode('event', 'ğŸ¹', '#ffffff')">ğŸ¹</button>
                    <button class="sidebar-item w-10 h-10 rounded-lg bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center text-lg text-gray-400 hover:text-blue-500 hover:border-blue-300" 
                         onclick="app.addNode('event', 'SELECT_ME', '#ffffff')">â•</button>
                </div>
            </aside>

            <!-- ä¸»ç”»å¸ƒ -->
            <main id="canvas-container" class="flex-1 relative overflow-hidden">
                <canvas id="boardCanvas" class="absolute top-0 left-0 block"></canvas>
                
                <!-- æç¤º Toast -->
                <div id="mode-toast" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-5 py-2 rounded-full text-sm shadow-xl opacity-0 transition-opacity pointer-events-none z-20 w-max backdrop-blur-sm flex items-center gap-2">
                    <span id="toast-icon">ğŸ”—</span> <span id="toast-msg">æ¨¡å¼å·²åˆ‡æ¢</span>
                </div>
            </main>
        </div>

        <!-- è§†å›¾2: æ—¥è®°æœ¬æ¨¡å¼ -->
        <div id="view-diary" class="w-full h-full absolute inset-0 z-10 hidden flex flex-col bg-[#FDFBF7]">
            <div class="p-4 sm:p-8 max-w-4xl mx-auto w-full h-full overflow-y-auto custom-scroll pb-24">
                <div class="flex items-end gap-3 mb-8 border-b border-gray-200 pb-4">
                    <h2 class="text-3xl text-gray-800">ğŸ“– å›å¿†å½•</h2>
                    <span class="text-sm text-white bg-orange-400 px-3 py-1 rounded-full font-bold shadow-sm" id="diary-count">0ç¯‡</span>
                </div>
                <div id="diary-list" class="space-y-6">
                    <!-- æ—¥è®°å¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª (è§£å†³é®æŒ¡é—®é¢˜) -->
        <div class="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-xl border border-gray-100 p-1 flex gap-1 z-40 ring-4 ring-black/5">
             <button id="nav-board-mobile" onclick="app.toggleView('board')" class="mobile-nav-btn active flex items-center gap-2 px-5 py-2 rounded-full text-sm font-bold text-gray-500 transition-all">
                <span>ğŸ¨</span> ç”»æ¿
            </button>
            <button id="nav-diary-mobile" onclick="app.toggleView('diary')" class="mobile-nav-btn flex items-center gap-2 px-5 py-2 rounded-full text-sm font-bold text-gray-500 transition-all">
                <span>ğŸ“–</span> æ—¥è®°
            </button>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† (é€šç”¨) -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900/40 hidden z-50 flex items-center justify-center backdrop-blur-[2px] px-4 transition-opacity">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl modal-enter border-4 border-white ring-4 ring-blue-50">
            <h2 id="modal-title" class="text-xl text-gray-800 mb-2 flex items-center gap-2">æ ‡é¢˜</h2>
            <p id="modal-desc" class="text-sm text-gray-500 mb-4 leading-relaxed hidden">ç¡®è®¤ï¼Ÿ</p>
            
            <textarea id="modal-input" class="w-full h-24 p-4 border-2 border-gray-200 rounded-xl bg-gray-50 text-lg focus:ring-0 focus:border-blue-400 focus:bg-white focus:outline-none resize-none mb-2 transition-colors placeholder-gray-300"></textarea>
            
            <div id="modal-date-picker" class="hidden mb-6 bg-blue-50 p-3 rounded-xl border border-blue-100">
                <label class="block text-xs text-blue-500 mb-1 font-bold uppercase">ğŸ“… é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="date-input" class="w-full p-2 border border-gray-300 rounded-lg bg-white font-bold text-gray-700 focus:outline-none focus:border-blue-400">
            </div>
            
            <!-- ä»…ç”¨äºè®¾ç½®é¡µé¢çš„å†…å®¹ -->
            <div id="modal-settings-content" class="hidden mb-4 space-y-3">
                <p class="text-xs text-gray-400 mb-2">æ•°æ®åªä¿å­˜åœ¨è¿™å°è®¾å¤‡ä¸Šã€‚å¦‚æœä½ è¦æ¢æ‰‹æœºï¼Œè¯·å…ˆã€å¤‡ä»½æ•°æ®ã€‘ï¼Œç„¶ååœ¨å¦ä¸€å°æ‰‹æœºä¸Šã€æ¢å¤æ•°æ®ã€‘ã€‚</p>
                <button onclick="app.exportData()" class="w-full py-3 bg-green-50 text-green-600 rounded-xl font-bold border border-green-200 hover:bg-green-100 text-left px-4 flex justify-between items-center">
                    <span>ğŸ“¤ å¤‡ä»½æ•°æ® (ä¸‹è½½æ–‡ä»¶)</span>
                    <span class="text-xl">â¬‡ï¸</span>
                </button>
                <div class="relative">
                    <button class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold border border-blue-200 hover:bg-blue-100 text-left px-4 flex justify-between items-center">
                        <span>ğŸ“¥ æ¢å¤æ•°æ® (é€‰æ–‡ä»¶)</span>
                        <span class="text-xl">â¬†ï¸</span>
                    </button>
                    <input type="file" id="import-file" onchange="app.importData(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <div class="text-center mt-2">
                    <button onclick="app.showSettings(true)" class="text-xs text-gray-400 underline">å…³äºã€æˆ‘çš„å°é˜Ÿã€‘</button>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-4" id="modal-buttons">
                <button onclick="app.closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-bold text-sm transition-colors">å–æ¶ˆ</button>
                <button id="modal-action" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold shadow-lg shadow-blue-200 transform active:scale-95 transition-all text-sm">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emoji-overlay" class="fixed inset-0 bg-gray-900/40 hidden z-50 flex items-center justify-center backdrop-blur-[2px] px-4">
        <div class="bg-white rounded-2xl p-4 w-full max-w-sm shadow-2xl max-h-[70vh] flex flex-col modal-enter ring-4 ring-yellow-50">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-lg text-gray-800" id="emoji-title">âœ¨ é€‰æ‹©è´´çº¸</h2>
                <button onclick="document.getElementById('emoji-overlay').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition">&times;</button>
            </div>
            <div id="emoji-grid" class="grid grid-cols-5 gap-2 overflow-y-auto custom-scroll p-1 text-center"></div>
        </div>
    </div>

    <script>
        const app = (function() {
            const canvas = document.getElementById('boardCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('canvas-container');
            
            const STORAGE_KEY_DRAFT = 'kids_diary_draft_v4'; 
            const STORAGE_KEY_HISTORY = 'kids_diary_history_v1';
            const ME_ID = 'USER_ME';
            
            let dpr = window.devicePixelRatio || 1;

            const EMOJI_LIB = {
                person: ["ğŸ‘¶","ğŸ‘§","ğŸ§’","ğŸ‘¦","ğŸ‘©","ğŸ§‘","ğŸ‘¨","ğŸ‘µ","ğŸ§“","ğŸ‘´","ğŸ‘®","ğŸ‘©â€âš•ï¸","ğŸ§‘â€ğŸ«","ğŸ‘¨â€ğŸ³","ğŸ¦¸","ğŸ§™","ğŸ§š","ğŸ‘»","ğŸ¤–","ğŸ‘¸","ğŸ¶","ğŸ±"],
                event: ["ğŸ¹","ğŸ¸","ğŸ»","ğŸº","ğŸ¥","ğŸ¤","ğŸ¼","ğŸ§","âš½","ğŸ€","ğŸ¨","ğŸ¬","ğŸ®","ğŸ“š","ğŸ«","ğŸ¥ª","ğŸ‚","ğŸ","ğŸ“±","ğŸšŒ","ğŸ–ï¸","ğŸ¥","ğŸ§¸"],
                fruit: ["ğŸŠ","ğŸ","ğŸ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥"],
                group: ["ğŸš©","ğŸ ","ğŸ•ï¸","ğŸš¤","ğŸš€","ğŸ°","ğŸŸï¸","ğŸ«","ğŸŒ³"]
            };

            let nodes = [];
            let links = [];
            let width, height;
            let mode = 'move';
            // ä¿®å¤ BUGï¼šæ˜¾å¼å®šä¹‰ diaryHistoryï¼Œé˜²æ­¢é¦–æ¬¡åŠ è½½å´©æºƒ
            let diaryHistory = []; 
            
            const state = {
                draggingNode: null,
                connectingNode: null,
                hoverNode: null,
                hoverLink: null,
                dragOffset: { x: 0, y: 0 },
                mouseX: 0, mouseY: 0,
                lastTouchTime: 0,
                longPressTimer: null
            };

            const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#FF9F43', '#A3CB38', '#f368e0'];

            function init() {
                resize();
                window.addEventListener('resize', resize);
                setupEvents();
                updateDateDisplay();
                loadDraft();
                loadHistory();
                ensureMeNode();
                requestAnimationFrame(animate);
            }

            function ensureMeNode() {
                if (!nodes.find(n => n.id === ME_ID)) {
                    nodes.push({
                        id: ME_ID,
                        x: width / 2,
                        y: height / 2,
                        type: 'person',
                        emoji: 'ğŸ•µï¸',
                        color: '#FFD93D',
                        label: 'æˆ‘',
                        scale: 1
                    });
                }
            }

            function updateDateDisplay() {
                const now = new Date();
                const options = { weekday: 'short', month: 'numeric', day: 'numeric' };
                document.getElementById('date-display').innerText = now.toLocaleDateString('zh-CN', options);
                
                // ä¼˜åŒ–ï¼šæ‰‹åŠ¨è®¾ç½® value å­—ç¬¦ä¸²ï¼Œè§£å†³éƒ¨åˆ†å®‰å“æµè§ˆå™¨ input date æ— æ³•è‡ªåŠ¨è·å–é»˜è®¤å€¼çš„é—®é¢˜
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                document.getElementById('date-input').value = `${y}-${m}-${d}`;
            }

            function resize() {
                width = container.clientWidth;
                height = container.clientHeight;
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                ctx.scale(dpr, dpr);
                nodes.forEach(n => {
                    n.x = Math.min(Math.max(n.x, 30), width - 30);
                    n.y = Math.min(Math.max(n.y, 30), height - 30);
                });
            }

            function toggleView(viewName) {
                const board = document.getElementById('view-board');
                const diary = document.getElementById('view-diary');
                const tools = document.getElementById('board-tools');
                
                // æ¡Œé¢ç«¯æŒ‰é’®
                const btnBoardDesk = document.getElementById('nav-board-desktop');
                const btnDiaryDesk = document.getElementById('nav-diary-desktop');
                // ç§»åŠ¨ç«¯æŒ‰é’®
                const btnBoardMob = document.getElementById('nav-board-mobile');
                const btnDiaryMob = document.getElementById('nav-diary-mobile');

                const activeDesk = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white text-blue-600 ring-1 ring-black/5 font-bold";
                const inactiveDesk = "flex items-center gap-1 px-4 py-2 rounded-lg text-sm transition-all text-gray-500 hover:bg-gray-200/50";

                if (viewName === 'board') {
                    board.classList.remove('hidden');
                    diary.classList.add('hidden');
                    // åœ¨ç§»åŠ¨ç«¯ï¼Œå·¥å…·æ å§‹ç»ˆæ˜¾ç¤ºï¼ŒNavåœ¨åº•éƒ¨
                    if(window.innerWidth >= 768) tools.classList.remove('hidden');
                    
                    btnBoardDesk.className = activeDesk;
                    btnDiaryDesk.className = inactiveDesk;
                    
                    btnBoardMob.classList.add('active');
                    btnDiaryMob.classList.remove('active');
                } else {
                    board.classList.add('hidden');
                    diary.classList.remove('hidden');
                    if(window.innerWidth >= 768) tools.classList.add('hidden');

                    btnDiaryDesk.className = activeDesk;
                    btnBoardDesk.className = inactiveDesk;

                    btnDiaryMob.classList.add('active');
                    btnBoardMob.classList.remove('active');
                    renderDiaryList(); 
                }
            }

            function setMode(newMode) {
                mode = newMode;
                const btnMove = document.getElementById('btn-move');
                const btnLink = document.getElementById('btn-link');
                const toast = document.getElementById('mode-toast');
                const toastMsg = document.getElementById('toast-msg');
                const toastIcon = document.getElementById('toast-icon');
                
                const activeClass = "w-9 h-9 flex items-center justify-center rounded-md bg-white shadow text-blue-600 ring-1 ring-blue-100 transform scale-105 transition-all text-xl";
                const inactiveClass = "w-9 h-9 flex items-center justify-center rounded-md text-gray-400 hover:text-blue-500 transition-all text-xl";

                if (mode === 'move') {
                    btnMove.className = activeClass;
                    btnLink.className = inactiveClass;
                    container.classList.remove('mode-link');
                    toastMsg.innerText = "ç§»åŠ¨æ¨¡å¼"; toastIcon.innerText = "âœ‹";
                } else {
                    btnLink.className = activeClass;
                    btnMove.className = inactiveClass;
                    container.classList.add('mode-link');
                    toastMsg.innerText = "è¿çº¿æ¨¡å¼"; toastIcon.innerText = "ğŸ”—";
                }

                toast.style.opacity = '1';
                setTimeout(() => toast.style.opacity = '0', 1500);
            }

            // --- ç»˜å›¾ ---
            function animate() {
                ctx.clearRect(0, 0, width, height);
                links.forEach(link => drawLink(link));
                if (state.connectingNode) drawCurve(state.connectingNode.x, state.connectingNode.y, state.mouseX, state.mouseY, '#4299e1', true);
                nodes.forEach(node => drawNode(node));
                requestAnimationFrame(animate);
            }

            function drawNode(node) {
                const isHover = state.hoverNode === node;
                const isDragging = state.draggingNode === node;
                const isMe = node.id === ME_ID;
                
                const targetScale = isDragging || isHover ? 1.15 : 1.0;
                node.scale = node.scale ? node.scale * 0.8 + targetScale * 0.2 : 1.0;

                ctx.save();
                ctx.translate(node.x, node.y);
                ctx.scale(node.scale, node.scale);

                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = isDragging ? 20 : 10;
                ctx.shadowOffsetY = isDragging ? 10 : 5;

                ctx.beginPath();
                if (node.type === 'group') {
                    ctx.roundRect(-45, -45, 90, 90, 16);
                    ctx.setLineDash([8, 6]);
                } else if (node.type === 'event') {
                    ctx.roundRect(-35, -35, 70, 70, 14);
                } else {
                    ctx.arc(0, 0, 36, 0, Math.PI * 2);
                }

                ctx.fillStyle = node.color;
                ctx.fill();
                
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#fff';
                if (isMe) ctx.strokeStyle = '#FFD93D';
                else if (state.connectingNode && isHover && state.connectingNode !== node) ctx.strokeStyle = '#4299e1';
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.shadowColor = 'transparent';
                ctx.font = node.type === 'group' ? "48px Apple Color Emoji, Segoe UI Emoji" : "40px Apple Color Emoji, Segoe UI Emoji";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                const yOffset = navigator.platform.indexOf('Win') > -1 ? 4 : 2; 
                ctx.fillText(node.emoji, 0, yOffset);

                drawLabel(node.label, 0, node.type === 'group' ? 58 : 50, true, node.color);
                ctx.restore();
            }

            function drawLink(link) {
                const s = nodes.find(n => n.id === link.source);
                const t = nodes.find(n => n.id === link.target);
                if (!s || !t) return;

                const isHover = state.hoverLink === link;
                const color = isHover ? '#4299e1' : '#CBD5E0';
                const lineWidth = isHover ? 5 : 3;

                drawCurve(s.x, s.y, t.x, t.y, color, false, lineWidth);

                if (link.label) {
                    const mid = getCurveMidPoint(s.x, s.y, t.x, t.y);
                    ctx.save();
                    ctx.translate(mid.x, mid.y);
                    drawLabel(link.label, 0, 0, false, isHover ? '#ebf8ff' : '#fff');
                    ctx.restore();
                }
            }

            function drawCurve(x1, y1, x2, y2, color, dashed = false, width = 3) {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                const dx = x2 - x1;
                const dy = y2 - y1;
                const factor = 0.2; 
                const cpX = (x1 + x2) / 2 - dy * factor * 0.5;
                const cpY = (y1 + y2) / 2 + dx * factor * 0.5;
                ctx.quadraticCurveTo(cpX, cpY, x2, y2);
                ctx.lineCap = 'round';
                ctx.lineWidth = width;
                ctx.strokeStyle = color;
                if (dashed) ctx.setLineDash([8, 8]);
                else ctx.setLineDash([]);
                ctx.stroke();
            }

            function getCurveMidPoint(x1, y1, x2, y2) {
                const dx = x2 - x1;
                const dy = y2 - y1;
                const factor = 0.2;
                const midX = (x1 + x2) / 2 - dy * factor * 0.25; 
                const midY = (y1 + y2) / 2 + dx * factor * 0.25;
                return { x: midX, y: midY };
            }

            function drawLabel(text, x, y, isNode, bgOverride) {
                ctx.font = "bold 14px 'ZCOOL KuaiLe', sans-serif";
                const metrics = ctx.measureText(text);
                const w = metrics.width + 16;
                const h = 26;
                
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetY = 2;
                ctx.fillStyle = bgOverride || "rgba(255, 255, 255, 0.95)";
                ctx.beginPath();
                const startY = isNode ? y : y - h/2;
                ctx.roundRect(x - w/2, startY, w, h, 8);
                ctx.fill();
                ctx.fillStyle = "#4b5563";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowColor = 'transparent';
                ctx.fillText(text, x, startY + h/2 + 1);
                ctx.restore();
            }

            function getPointerPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: (clientX - rect.left), y: (clientY - rect.top) };
            }

            function checkHover(x, y) {
                state.hoverLink = null;
                for (let i = links.length - 1; i >= 0; i--) {
                    const l = links[i];
                    const s = nodes.find(n => n.id === l.source);
                    const t = nodes.find(n => n.id === l.target);
                    if (!s || !t) continue;
                    drawCurve(s.x, s.y, t.x, t.y, 'transparent', false, 15);
                    if (ctx.isPointInStroke(x * dpr, y * dpr)) {
                        state.hoverLink = l;
                        break; 
                    }
                }
                state.hoverNode = null;
                for (let i = nodes.length - 1; i >= 0; i--) {
                    const n = nodes[i];
                    const r = n.type === 'group' ? 50 : 40;
                    if (Math.abs(x - n.x) < r && Math.abs(y - n.y) < r) {
                        state.hoverNode = n;
                        state.hoverLink = null;
                        break;
                    }
                }
                container.style.cursor = state.hoverNode ? 'grab' : (state.hoverLink ? 'pointer' : (mode==='link' ? 'crosshair' : 'default'));
            }

            function handleStart(e) {
                if(e.target === canvas) e.preventDefault(); 
                const { x, y } = getPointerPos(e);
                checkHover(x, y);

                const now = Date.now();
                if (now - state.lastTouchTime < 300) { handleDoubleClick(e); return; }
                state.lastTouchTime = now;

                if (state.hoverNode) {
                    if (mode === 'link' || e.shiftKey) {
                        state.connectingNode = state.hoverNode;
                    } else {
                        state.draggingNode = state.hoverNode;
                        state.dragOffset = { x: x - state.hoverNode.x, y: y - state.hoverNode.y };
                    }
                }
                state.mouseX = x; state.mouseY = y;
            }

            function handleMove(e) {
                if(e.target === canvas) e.preventDefault();
                const { x, y } = getPointerPos(e);
                state.mouseX = x; state.mouseY = y;
                
                if (state.draggingNode) {
                    const margin = 30;
                    state.draggingNode.x = Math.max(margin, Math.min(width - margin, x - state.dragOffset.x));
                    state.draggingNode.y = Math.max(margin, Math.min(height - margin, y - state.dragOffset.y));
                } else {
                    checkHover(x, y);
                }
            }

            function handleEnd(e) {
                if (state.connectingNode) {
                    checkHover(state.mouseX, state.mouseY);
                    const target = state.hoverNode;
                    if (target && target !== state.connectingNode) {
                        const exists = links.find(l => 
                            (l.source === state.connectingNode.id && l.target === target.id) || 
                            (l.source === target.id && l.target === state.connectingNode.id)
                        );
                        if (!exists) {
                            links.push({ id: Date.now().toString(), source: state.connectingNode.id, target: target.id, label: "äº’åŠ¨" });
                            saveDraft();
                        }
                    }
                    state.connectingNode = null;
                }
                if (state.draggingNode) {
                    state.draggingNode = null;
                    saveDraft();
                }
            }

            function handleDoubleClick(e) {
                if (state.hoverNode) {
                    const n = state.hoverNode;
                    if (n.id === ME_ID) {
                        showEmojiPicker('fruit', (emoji) => { n.emoji = emoji; saveDraft(); });
                    } else {
                        showDialog({
                            title: "âœï¸ å®ƒæ˜¯è°ï¼Ÿ",
                            inputValue: n.label,
                            onConfirm: (val) => { if(val) { n.label = val; saveDraft(); return true; } }
                        });
                    }
                } else if (state.hoverLink) {
                    const l = state.hoverLink;
                    showDialog({
                        title: "âœï¸ å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ",
                        inputValue: l.label,
                        onConfirm: (val) => { if(val) { l.label = val; saveDraft(); return true; } }
                    });
                }
            }
            
            function handleContextMenu(e) {
                e.preventDefault();
                const { x, y } = getPointerPos(e);
                checkHover(x, y);
                if (state.hoverNode) {
                    if (state.hoverNode.id === ME_ID) return;
                    showDialog({
                        title: "ğŸ—‘ï¸ åˆ é™¤",
                        desc: `è¦è®© "${state.hoverNode.label}" æ¶ˆå¤±å—ï¼Ÿ`,
                        isConfirm: true,
                        onConfirm: () => {
                            nodes = nodes.filter(n => n.id !== state.hoverNode.id);
                            links = links.filter(l => l.source !== state.hoverNode.id && l.target !== state.hoverNode.id);
                            saveDraft();
                            state.hoverNode = null;
                            return true;
                        }
                    });
                } else if (state.hoverLink) {
                    showDialog({
                        title: "ğŸ—‘ï¸ æ–­å¼€è¿æ¥",
                        desc: "è¦åˆ‡æ–­è¿™æ¡è¿çº¿å—ï¼Ÿ",
                        isConfirm: true,
                        onConfirm: () => {
                            links = links.filter(l => l.id !== state.hoverLink.id);
                            saveDraft();
                            state.hoverLink = null;
                            return true;
                        }
                    });
                }
            }

            function setupEvents() {
                canvas.addEventListener('mousedown', handleStart);
                canvas.addEventListener('mousemove', handleMove);
                canvas.addEventListener('mouseup', handleEnd);
                canvas.addEventListener('mouseleave', () => { state.draggingNode = null; state.connectingNode = null; });
                canvas.addEventListener('touchstart', handleStart, {passive: false});
                canvas.addEventListener('touchmove', handleMove, {passive: false});
                canvas.addEventListener('touchend', handleEnd);
                canvas.addEventListener('contextmenu', handleContextMenu);
            }

            function addNode(type, emoji, color) {
                if (emoji === 'SELECT_ME') {
                    showEmojiPicker(type, (selectedEmoji) => {
                        createNode(type, selectedEmoji, type === 'person' ? (color === 'RANDOM' ? getRandomColor() : color) : '#ffffff');
                    });
                } else {
                    createNode(type, emoji, color);
                }
                if (navigator.vibrate) navigator.vibrate(50);
            }

            function getRandomColor() { return COLORS[Math.floor(Math.random() * COLORS.length)]; }

            function createNode(type, emoji, color) {
                const x = width / 2 + (Math.random() * 60 - 30);
                const y = height / 2 + (Math.random() * 60 - 30);
                const id = Date.now().toString(36) + Math.random().toString(36).slice(2);
                let label = "æ–°äº‹ç‰©";
                if (type === 'person') label = "æ–°æœ‹å‹";
                if (type === 'group') label = "åŸºåœ°";
                nodes.push({ id, x, y, type, emoji, color, label, scale: 0 });
                saveDraft();
            }

            // --- æ¨¡æ€æ¡†ä¸è®¾ç½® ---
            function showDialog({ title, desc, inputValue, onConfirm, isConfirm }) {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const descEl = document.getElementById('modal-desc');
                const inputEl = document.getElementById('modal-input');
                const dateEl = document.getElementById('modal-date-picker');
                const settingsEl = document.getElementById('modal-settings-content');
                const btnContainer = document.getElementById('modal-buttons');
                const btn = document.getElementById('modal-action');
                
                overlay.classList.remove('hidden');
                titleEl.innerText = title;
                settingsEl.classList.add('hidden');
                btnContainer.classList.remove('hidden');
                
                if (isConfirm) {
                    inputEl.classList.add('hidden');
                    dateEl.classList.add('hidden');
                    descEl.classList.remove('hidden');
                    descEl.innerText = desc;
                } else {
                    descEl.classList.add('hidden');
                    dateEl.classList.add('hidden');
                    inputEl.classList.remove('hidden');
                    inputEl.value = inputValue || "";
                    setTimeout(() => inputEl.focus(), 100);
                }

                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.onclick = () => {
                    if (onConfirm) {
                        const result = onConfirm(inputEl.value);
                        if (result !== false) closeModal();
                    } else {
                        closeModal();
                    }
                };
            }

            // æ–°å¢ï¼šæ˜¾ç¤ºè®¾ç½®/å¤‡ä»½é¢æ¿
            function showSettings(showHelp = false) {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const descEl = document.getElementById('modal-desc');
                const inputEl = document.getElementById('modal-input');
                const dateEl = document.getElementById('modal-date-picker');
                const settingsEl = document.getElementById('modal-settings-content');
                const btnContainer = document.getElementById('modal-buttons');

                overlay.classList.remove('hidden');
                inputEl.classList.add('hidden');
                dateEl.classList.add('hidden');
                
                if(showHelp) {
                     titleEl.innerText = "ğŸ³ï¸ å…³äºã€æˆ‘çš„å°é˜Ÿã€‘";
                     descEl.classList.remove('hidden');
                     descEl.innerHTML = "è¿™æ˜¯ä¸€ä¸ªç”¨æ¥<b>åˆ†ç»„</b>çš„åŠŸèƒ½ã€‚<br><br>1. æŠŠæ——å¸œğŸš©æ‹–åˆ°ä¸­é—´ã€‚<br>2. ç»™å®ƒèµ·ä¸ªåå­—ï¼Œæ¯”å¦‚â€œå­¦æ ¡â€ã€‚<br>3. æŠŠåŒå­¦ä»¬çš„å¤´åƒæ‹–åˆ°å®ƒæ—è¾¹ã€‚<br><br>è¿™æ ·ä½ å°±çŸ¥é“å“ªäº›æœ‹å‹æ˜¯å“ªä¸€ä¼™çš„å•¦ï¼";
                     settingsEl.classList.add('hidden');
                     btnContainer.classList.remove('hidden');
                     const btn = document.getElementById('modal-action');
                     const newBtn = btn.cloneNode(true);
                     btn.parentNode.replaceChild(newBtn, btn);
                     newBtn.onclick = closeModal;
                } else {
                    titleEl.innerText = "âš™ï¸ è®¾ç½®ä¸å¤‡ä»½";
                    descEl.classList.add('hidden');
                    settingsEl.classList.remove('hidden');
                    btnContainer.classList.remove('hidden');
                    // åªæœ‰å–æ¶ˆæŒ‰é’®æœ‰æ•ˆï¼Œç¡®å®šæŒ‰é’®åœ¨è®¾ç½®é¡µæ„ä¹‰ä¸å¤§ï¼Œæˆ–è€…ä½œä¸ºå…³é—­
                    const btn = document.getElementById('modal-action');
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = closeModal;
                }
            }

            function closeModal() {
                document.getElementById('modal-overlay').classList.add('hidden');
            }

            // --- æ•°æ®å¯¼å‡º/å¯¼å…¥ ---
            function exportData() {
                const data = {
                    draft: JSON.parse(localStorage.getItem(STORAGE_KEY_DRAFT) || '{}'),
                    history: JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '[]')
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ä¾¦æ¢æ—¥è®°å¤‡ä»½_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.draft) localStorage.setItem(STORAGE_KEY_DRAFT, JSON.stringify(data.draft));
                        if (data.history) localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(data.history));
                        alert("æ•°æ®æ¢å¤æˆåŠŸï¼å³å°†åˆ·æ–°é¡µé¢...");
                        location.reload();
                    } catch (err) {
                        alert("æ–‡ä»¶å¥½åƒåæ‰äº†ï¼Œæ— æ³•è¯»å– ğŸ˜¢");
                    }
                };
                reader.readAsText(file);
            }

            // --- æ—¥è®°åŠŸèƒ½ ---
            function saveToDiary() {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const descEl = document.getElementById('modal-desc');
                const inputEl = document.getElementById('modal-input');
                const datePicker = document.getElementById('modal-date-picker');
                const dateInput = document.getElementById('date-input');
                const btn = document.getElementById('modal-action');
                const settingsEl = document.getElementById('modal-settings-content');

                overlay.classList.remove('hidden');
                titleEl.innerText = "ğŸ’¾ ä¿å­˜å›å¿†";
                inputEl.classList.add('hidden');
                settingsEl.classList.add('hidden');
                descEl.classList.remove('hidden');
                descEl.innerText = "æˆ‘ä»¬è¦æŠŠä»Šå¤©çš„ä¾¦æ¢ç”»æ¿å­˜èµ·æ¥å—ï¼Ÿ";
                datePicker.classList.remove('hidden');
                
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.onclick = () => {
                    let date = dateInput.value;
                    // å…œåº•é€»è¾‘ï¼šå¦‚æœæ—¥æœŸè¾“å…¥æ¡†å¤±æ•ˆï¼ˆç©ºï¼‰ï¼Œå¼ºåˆ¶ä½¿ç”¨ä»Šå¤©
                    if (!date) {
                         const now = new Date();
                         const y = now.getFullYear();
                         const m = String(now.getMonth() + 1).padStart(2, '0');
                         const d = String(now.getDate()).padStart(2, '0');
                         date = `${y}-${m}-${d}`;
                    }
                    
                    const snapshot = {
                        nodes: JSON.parse(JSON.stringify(nodes)),
                        links: JSON.parse(JSON.stringify(links))
                    };

                    // å®‰å…¨æ£€æŸ¥ï¼Œé˜²æ­¢ diaryHistory æœªå®šä¹‰
                    if (!diaryHistory) diaryHistory = [];

                    const existingIdx = diaryHistory.findIndex(d => d.date === date);
                    if (existingIdx >= 0) {
                        diaryHistory[existingIdx] = { ...snapshot, date, timestamp: Date.now() };
                    } else {
                        diaryHistory.unshift({ ...snapshot, date, timestamp: Date.now() });
                    }
                    
                    diaryHistory.sort((a,b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(diaryHistory));
                    closeModal();
                    toggleView('diary');
                };
            }

            function renderDiaryList() {
                const list = document.getElementById('diary-list');
                const count = document.getElementById('diary-count');
                list.innerHTML = '';
                
                // å®‰å…¨æ£€æŸ¥
                if (!diaryHistory) diaryHistory = [];

                count.innerText = diaryHistory.length + "ç¯‡";

                if (diaryHistory.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 opacity-50"><div class="text-6xl mb-4">ğŸ“­</div><p>è¿˜æ²¡æœ‰æ—¥è®°å“¦ï¼Œå¿«å»ç”»æ¿è®°å½•å§ï¼</p></div>`;
                    return;
                }

                diaryHistory.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "diary-card p-5 rounded-2xl shadow-sm border border-gray-100 relative";
                    const actionCount = item.links.length;
                    const peopleCount = item.nodes.filter(n => n.type === 'person' && n.id !== ME_ID).length;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-md">${item.date}</span>
                                </h3>
                            </div>
                            <button onclick="app.deleteDiary(${idx})" class="text-gray-300 hover:text-red-500 transition px-2 text-xl">&times;</button>
                        </div>
                        <div class="text-gray-600 text-sm mb-4 bg-white/50 p-3 rounded-lg border border-gray-50">
                            ğŸ•µï¸ å‘ç°äº† ${peopleCount} ä¸ªæœ‹å‹ï¼Œè®°å½•äº† ${actionCount} ä¸ªäº’åŠ¨ã€‚
                        </div>
                        <div class="flex justify-end">
                            <button onclick="app.loadDiary(${idx})" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 transition flex items-center gap-1">
                                <span>ğŸ‘€</span> æŸ¥çœ‹å½“æ—¶çš„ç”»æ¿
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            function loadDiary(idx) {
                showDialog({
                    title: "â³ æ—¶å…‰å€’æµ",
                    desc: "ç¡®å®šè¦å›åˆ°è¿™ä¸€å¤©å—ï¼Ÿå½“å‰ç”»æ¿ä¸Šæ²¡ä¿å­˜çš„å†…å®¹ä¼šæ¶ˆå¤±å“¦ã€‚",
                    isConfirm: true,
                    onConfirm: () => {
                        const item = diaryHistory[idx];
                        nodes = JSON.parse(JSON.stringify(item.nodes));
                        links = JSON.parse(JSON.stringify(item.links));
                        saveDraft();
                        toggleView('board');
                        return true;
                    }
                });
            }

            function deleteDiary(idx) {
                showDialog({
                    title: "ğŸ—‘ï¸ æ’•æ‰è¿™é¡µ",
                    desc: "ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ",
                    isConfirm: true,
                    onConfirm: () => {
                        diaryHistory.splice(idx, 1);
                        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(diaryHistory));
                        renderDiaryList();
                        return true;
                    }
                });
            }

            function clearBoard() {
                showDialog({
                    title: "ğŸ§¹ å¤§æ‰«é™¤",
                    desc: "ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ",
                    isConfirm: true,
                    onConfirm: () => {
                        nodes = []; links = []; ensureMeNode(); saveDraft(); return true;
                    }
                });
            }

            function showEmojiPicker(type, callback) {
                const el = document.getElementById('emoji-overlay');
                const grid = document.getElementById('emoji-grid');
                const title = document.getElementById('emoji-title');
                
                el.classList.remove('hidden');
                grid.innerHTML = '';
                title.innerText = type === 'fruit' ? "ğŸŠ å˜èº«" : "âœ¨ é€‰æ‹©è´´çº¸";
                
                const list = EMOJI_LIB[type] || EMOJI_LIB['person'];
                list.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.innerText = emoji;
                    btn.className = "text-3xl h-12 w-12 flex items-center justify-center hover:bg-gray-100 rounded-xl transition active:scale-90";
                    btn.onclick = () => {
                        callback(emoji);
                        el.classList.add('hidden');
                    }
                    grid.appendChild(btn);
                });
            }

            function saveDraft() {
                localStorage.setItem(STORAGE_KEY_DRAFT, JSON.stringify({ nodes, links }));
            }
            function loadDraft() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY_DRAFT);
                    if(raw) {
                        const d = JSON.parse(raw);
                        nodes = d.nodes || []; links = d.links || [];
                    }
                } catch(e) {}
            }
            function loadHistory() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
                    if(raw) diaryHistory = JSON.parse(raw);
                } catch(e) {}
            }

            return {
                init, toggleView, setMode, addNode,
                saveToDiary, loadDiary, deleteDiary, clearBoard, closeModal,
                showSettings, exportData, importData
            };
        })();

        window.onload = app.init;
    </script>
</body>
</html>
